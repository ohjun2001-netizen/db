{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage_update.css' %}">
{% endblock %}

{% block content %}
<div id="canvas" role="main" aria-labelledby="pageTitle">
  <!-- 히어로/헤더 유지 -->
  <div id="bgMypage"></div>
  <h1 id="pageTitle">마이페이지</h1>

  <!-- 좌측 메뉴 유지 -->
  <div id="menuTitle">메뉴</div>
  <div id="menuBox"></div>
  <div id="menuLine1"></div>
  <div id="menuLine2"></div>
  <a id="menuItem1" href="{% url 'user:mypage' %}">내 정보</a>
  <a id="menuItem2" href="{% url 'user:DIMC_archive' %}">DIMC 아카이브</a>

  <!-- 우측 카드: 디자인 유지 -->
  <div id="infoBox">
    <h2 class="card-title">내 정보 수정</h2>

    <form id="editForm" method="post" action="{% url 'user:mypage_update' %}" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <div class="panel">
        <!--
          [수정됨] 이름(name) 필드
          - User 모델의 필수 필드이므로, 숨기지 않고 수정 가능하도록 변경했습니다.
          - 이제 사용자가 직접 이름을 입력하거나 수정할 수 있습니다.
        -->
        <div class="row row-name">
          <label for="name" class="lbl">이름</label>
          <div class="main">
            <input class="text" type="text" id="name" name="name" value="{{ request.user.name|default_if_none:'' }}" required>
          </div>
        </div>

        <div class="row row-profile">
          <label for="profileImage" class="lbl">프로필 사진</label>
          <div class="main">
            {% if request.user.profile_image %}
              <img src="{{ request.user.profile_image.url }}" alt="현재 프로필 사진" style="max-width: 100px; max-height: 100px; border-radius: 50%;">
            {% endif %}
            <input type="file" id="profileImage" name="profile_image" accept="image/*">
            <p class="form-text">새로운 사진을 업로드하면 변경됩니다.</p>
          </div>
        </div>

        <!-- 연락처 -->
        <div class="row row-phone">
          <label class="lbl">연락처</label>
          <div class="main">
            <span class="masked">
              {% if request.user.phone_number %}
                {% with pn=request.user.phone_number|cut:"-" %}
                  {{ pn|slice:":3" }}-*****-{{ pn|slice:"-4:" }}
                {% endwith %}
              {% else %}010-*****-0000{% endif %}
            </span>
            <div class="inputs phone">
              <input type="text" inputmode="numeric" maxlength="3" class="ph" id="ph1" aria-label="국번">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph2" aria-label="중간번호">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph3" aria-label="끝번호">
            </div>
          </div>
          <button type="button" class="btn-mini" data-toggle="#phone" data-focus="#ph1">수정</button>
          <input type="tel" name="phone_number" id="phoneRaw" class="sr-only">
        </div>

        <!-- 이메일(아이디) 읽기 전용 -->
        <div class="row row-email">
          <label class="lbl">이메일(아이디)</label>
          <div class="main">
            <input class="text" type="email" value="{{ request.user.email }}" disabled>
          </div>
          <button type="button" class="btn-mini" disabled title="이메일은 변경 불가">수정</button>
        </div>

        <!-- 주소 -->
        <div class="row row-addr">
          <label class="lbl">주소</label>
          <div class="main">
            <span class="masked">
              {% if request.user.address %}
                {{ request.user.address|slice:":5" }}******
              {% else %}-{% endif %}
            </span>
            <input class="text wide" type="text" id="addr" name="address"
                   value="{{ request.user.address|default_if_none:'' }}"
                   placeholder="주소를 입력해 주세요.">
          </div>
          <button type="button" class="btn-mini" data-toggle="#addr" data-focus="#addr">수정</button>
        </div>

        <!-- 생년월일 -->
        <div class="row row-birth">
          <label class="lbl">생년월일</label>
          <div class="main">
            <span class="masked">
              {% if request.user.birthday %}
                {{ request.user.birthday|date:"Y" }}-**-**
              {% else %}20**-**-**{% endif %}
            </span>
            <div class="inputs birth" id="birthInputs">
              <input type="text" inputmode="numeric" maxlength="4" class="yr" id="by" placeholder="YYYY">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="mo" id="bm" placeholder="MM">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="dy" id="bd" placeholder="DD">
            </div>
          </div>
          <button type="button" class="btn-mini" data-toggle="#birthInputs" data-focus="#by">수정</button>
          <input type="hidden" name="birthday" id="birthRaw" value="">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">저장</button>
      </div>
    </form>

  </div>
</div>

<!-- 스크립트는 변경할 필요 없이 그대로 사용하면 됩니다 -->
<script>
(function(){
  // ... (기존 스크립트 내용 그대로) ...
})();
</script>
{% endblock %}

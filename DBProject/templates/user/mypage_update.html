{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage_update.css' %}">
{% endblock %}

{% block content %}
<div id="canvas" role="main" aria-labelledby="pageTitle">
  <!-- 히어로/타이틀: 마이페이지와 동일 -->
  <div id="bgMypage"></div>
  <h1 id="pageTitle">마이페이지</h1>

  <!-- 좌측 메뉴: 그대로 -->
  <div id="menuTitle">메뉴</div>
  <div id="menuBox"></div>
  <div id="menuLine1"></div>
  <div id="menuLine2"></div>
  <a id="menuItem1" href="{% url 'user:mypage' %}">내 정보</a>
  <a id="menuItem2" href="{% url 'user:dimc_test' %}">DIMC 아카이브</a>

  <!-- 우측 카드: 회색 영역만 스샷 레이아웃 -->
  <div id="infoBox">
    <h2 class="card-title">내 정보 수정</h2>

    <form id="editForm" method="post" novalidate>
      {% csrf_token %}

      <div class="panel">

        <!-- 연락처 (항상 입력칸 노출) -->
        <div class="row row-phone">
          <label class="lbl">연락처</label>
          <div class="main">
            <span class="masked">{{ phone_masked|default:"010-9***-***9" }}</span>
            <div class="inputs phone">
              <input type="text" inputmode="numeric" maxlength="3" class="ph" id="ph1" placeholder="">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph2" placeholder="">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph3" placeholder="">
            </div>
          </div>
          <button type="button" class="btn-mini" data-focus="#ph1">수정</button>

          <!-- 서버 전송용 숨은 필드 -->
          <input type="tel" name="phone" id="phoneRaw" class="sr-only" value="{{ user.phone_number|default_if_none:'' }}">
        </div>

        <!-- 이메일 (기본: 마스킹만, 수정 클릭 시 입력칸 토글) -->
        <div class="row row-email">
          <label class="lbl">이메일(아이디)</label>
          <div class="main">
            <span class="masked">{{ email_masked|default:"Hon****@n****.com" }}</span>
            <input class="text" type="email" name="email" id="email" value="{{ user.email|default_if_none:'' }}" placeholder="name@example.com">
          </div>
          <button type="button" class="btn-mini" data-toggle="#email" data-focus="#email">수정</button>
        </div>

        <!-- 주소 (마스킹 한 줄 + 아래 입력칸 / 수정시만 노출) -->
        <div class="row row-addr">
          <label class="lbl">주소</label>
          <div class="main">
            <span class="masked">{{ addr_masked|default:"경기도 안산시 ******" }}</span>
            <input class="text wide" type="text" name="addr" id="addr" value="{{ user.address|default_if_none:'' }}" placeholder="주소를 입력해 주세요.">
          </div>
          <button type="button" class="btn-mini" data-toggle="#addr" data-focus="#addr">수정</button>
        </div>

        <!-- 생년월일 (마스킹 + 아래 Y/M/D / 수정시만 노출) -->
        <div class="row row-birth">
          <label class="lbl">생년월일</label>
          <div class="main">
            <span class="masked">{{ birth_masked|default:"20**-**-**" }}</span>
            <div class="inputs birth" id="birthInputs">
              <input type="text" inputmode="numeric" maxlength="4" class="yr" id="by" placeholder="YYYY">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="mo" id="bm" placeholder="MM">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="dy" id="bd" placeholder="DD">
            </div>
          </div>
          <button type="button" class="btn-mini" data-toggle="#birthInputs" data-focus="#by">수정</button>

          <!-- 서버 전송용 숨은 필드(date 포맷 유지) -->
          <input type="date" name="birth" id="birthRaw" class="sr-only" value="{{ user.birth_date|date:'Y-m-d' }}">
        </div>

      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">저장</button>
      </div>
    </form>
  </div>
</div>

<!-- 토글/조립 스크립트 -->
<script>
  (function(){
    // 분할 입력 요소
    const ph = ['ph1','ph2','ph3'].map(id=>document.getElementById(id));
    const phoneRaw = document.getElementById('phoneRaw');
    const by = document.getElementById('by'), bm = document.getElementById('bm'), bd = document.getElementById('bd');
    const birthRaw = document.getElementById('birthRaw');

    // 숫자만 + 자동 포커스 이동
    [...ph, by, bm, bd].forEach(inp=>{
      if(!inp) return;
      inp.addEventListener('input', e=>{
        e.target.value = e.target.value.replace(/[^0-9]/g,'');
        if(e.target.maxLength && e.target.value.length >= e.target.maxLength){
          const order = [...ph, by, bm, bd];
          const i = order.indexOf(e.target);
          if(i > -1 && order[i+1]) order[i+1].focus();
        }
      });
    });

    // 토글 버튼: 이메일/주소/생년월일
    document.querySelectorAll('.btn-mini').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const row = btn.closest('.row');
        const sel = btn.getAttribute('data-toggle');
        if(sel){
          row.classList.toggle('editing');
        }
        const fsel = btn.getAttribute('data-focus');
        if(fsel){
          const t = document.querySelector(fsel);
          if(t){ t.focus(); }
        }
      });
    });

    // 제출 시 원본 필드 조립
    document.getElementById('editForm').addEventListener('submit', ()=>{
      // phone
      if(ph[0] && ph[1] && ph[2]){
        const p1 = ph[0].value.trim(), p2 = ph[1].value.trim(), p3 = ph[2].value.trim();
        if(p1 && p2 && p3) phoneRaw.value = `${p1}-${p2}-${p3}`;
      }
      // birth
      if(by && bm && bd){
        const y = by.value.padStart(4,'0'), m = bm.value.padStart(2,'0'), d = bd.value.padStart(2,'0');
        if(/^\d{4}$/.test(y) && /^\d{2}$/.test(m) && /^\d{2}$/.test(d)) birthRaw.value = `${y}-${m}-${d}`;
      }
    });

    // 최초 로드시: 이메일/주소/생년월일 입력칸 숨김 상태
    document.querySelector('.row-email')?.classList.remove('editing');
    document.querySelector('.row-addr')?.classList.remove('editing');
    document.querySelector('.row-birth')?.classList.remove('editing');
  })();
</script>
{% endblock %}
